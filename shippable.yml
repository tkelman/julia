language: c
integrations:
  notifications:
    - integrationName: email
      type: email
      on_success: never
      on_failure: never
      on_cancel: never
      on_pull_request: never
build:
  pre_ci_boot:
      image_name: ubuntu
      image_tag: 14.04
      pull: true
      options: "-u 65534 -w /tmp"
  ci:
    - nproc
    - uname -a
    - cat /etc/os-release
    - sudo apt-get update &&
      sudo apt-get install -y g++-multilib gfortran-multilib
        curl make patch m4 xz-utils git time ccache bar
#      echo "override ARCH = $ARCH" | tee -a Make.user &&
    - make -C base version_git.jl.phony &&
      for var in FORCE_ASSERTIONS LLVM_ASSERTIONS USECCACHE NO_GIT; do
        echo "override $var = 1" | tee -a Make.user;
      done
    - contrib/download_cmake.sh &&
      make -j3 -C deps || make
    - make -j3 all &&
      make prefix=/tmp/julia install &&
      ccache -s &&
      make build-stats
    - cd .. &&
      mv project julia-src &&
      /tmp/julia/bin/julia -e 'versioninfo()' &&
      /tmp/julia/bin/julia --precompiled=no -e 'true' &&
      /tmp/julia/bin/julia-debug --precompiled=no -e 'true' &&
      pushd /tmp/julia/share/julia/test &&
      /tmp/julia/bin/julia --check-bounds=yes runtests.jl all | bar -i 30 &&
      /tmp/julia/bin/julia --check-bounds=yes runtests.jl libgit2-online download pkg &&
      popd &&
      mkdir /tmp/embedding-test &&
      make check -C /tmp/julia/share/doc/julia/examples/embedding \
        JULIA=/tmp/julia/bin/julia BIN=/tmp/embedding-test \
        "$(cd julia-src && make print-CC)" &&
      mv julia-src project
  cache: true
  cache_dir_list:
    - ~/.ccache
