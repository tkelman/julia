box: tkelman/mingw@0.1.0
build:
  steps:
    - script:
        name: cross-compile julia for win32
        code: "export XC_HOST=i686-w64-mingw32;
              echo 'LLVM_FLAGS = ac_cv_have_decl_strerror_s=no' > Make.user;
              git checkout -b $WERCKER_GIT_BRANCH $WERCKER_GIT_COMMIT;
              curl https://gist.githubusercontent.com/jeffery/1115504/raw/f51e8ff42ae90bb72f6b5d498ec9d98cd3cc81c1/GitRepoUpdateTimestamp.sh | bash;
              mkdir -p usr/bin;
              mkdir -p $WERCKER_CACHE_DIR/$XC_HOST;
              ls -al $WERCKER_CACHE_DIR/$XC_HOST;
              if [ -e $WERCKER_CACHE_DIR/$XC_HOST/dist-extras.tar ]; then
                tar -xf $WERCKER_CACHE_DIR/$XC_HOST/dist-extras.tar;
              else
                make win-extras;
                tar -cf $WERCKER_CACHE_DIR/$XC_HOST/dist-extras.tar dist-extras;
              fi;
              if [ -e $WERCKER_CACHE_DIR/$XC_HOST/usr.tar ]; then
                tar -xf $WERCKER_CACHE_DIR/$XC_HOST/usr.tar;
              fi;
              for i in llvm fftw gmp mpfr pcre dsfmt openblas suitesparse arpack; do
                if [ -e $WERCKER_CACHE_DIR/$XC_HOST/$i.tar ]; then
                  tar -xf $WERCKER_CACHE_DIR/$XC_HOST/$i.tar;
                fi;
                make -j8 -C deps install-$i;
                if [ $i = suitesparse ]; then
                  tar -cf $WERCKER_CACHE_DIR/$XC_HOST/$i.tar deps/SuiteSparse-*/ deps/SuiteSparse-*.tar.gz;
                else
                  tar -cf $WERCKER_CACHE_DIR/$XC_HOST/$i.tar deps/$i-*/ deps/$i-*.tar.*;
                fi;
              done;
              tar -cf $WERCKER_CACHE_DIR/$XC_HOST/usr.tar usr;
              sh base/version_git.sh;
              make -j8 dist;
              mv julia-*.exe $WERCKER_OUTPUT_DIR"
